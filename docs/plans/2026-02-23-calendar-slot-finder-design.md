# Calendar Slot Finder - Chrome拡張機能 設計書

## 概要

Googleカレンダーから複数人の重複しない空き時間を検索し、予定を作成できるChrome拡張機能。

## 利用シーン

起動時にユーザーが目的を選択する:

1. **会議の日程調整** - チームメンバー複数人の空き時間を見つけて会議をスケジュール
2. **リソース管理** - 誰がいつ空いているかを一覧で確認しタスクやシフトを割り当て
3. **個人の予定確認** - 自分と特定の相手の空き時間を素早く確認

## アーキテクチャ

### アプローチ: Google Calendar API直接利用

Chrome拡張からOAuth 2.0で認証し、Google Calendar APIを直接呼び出す。バックエンドサーバー不要。

```
┌─────────────────────────────────────────┐
│           Chrome Extension              │
├──────────┬──────────┬───────────────────┤
│ Popup    │ Content  │ Service Worker    │
│ (React)  │ Script   │ (Background)      │
│          │          │                   │
│ ・目的選択│ ・カレン │ ・OAuth管理        │
│ ・人選択  │  ダー    │ ・API呼出し        │
│ ・条件設定│  オーバー│ ・キャッシュ       │
│ ・結果一覧│  レイ    │ ・FreeBusy計算    │
└──────────┴──────────┴───────────────────┘
                │
                ▼
    ┌───────────────────────┐
    │  Google Calendar API  │
    │  ・FreeBusy API       │
    │  ・CalendarList API   │
    │  ・Events API         │
    │  ・People API         │
    └───────────────────────┘
```

### 3つのレイヤー

1. **Popup (React + TypeScript)**: メインUI。目的選択、人の追加、検索条件設定、結果表示
2. **Content Script**: Googleカレンダーページに注入。空き時間のハイライト表示、クリックで予定作成
3. **Service Worker**: バックグラウンドでOAuth認証管理、API呼び出し、データキャッシュ

### 使用API

- **FreeBusy API**: 複数人の空き/忙しい状態を一括取得
- **CalendarList API**: 共有カレンダー一覧の取得
- **Events API**: 予定の作成
- **People API (Directory)**: Workspaceユーザーの検索

## UIフロー

```
[拡張アイコンクリック]
        │
        ▼
┌─────────────────────┐
│   目的選択画面       │
│                     │
│  会議の日程調整      │
│  リソース管理        │
│  個人の予定確認      │
└─────────────────────┘
        │
        ▼
┌─────────────────────┐
│   メンバー選択画面   │
│                     │
│  [検索: 名前/メール] │
│  ┌─ 候補リスト ────┐│
│  │ 山田太郎        ││
│  │ 佐藤花子        ││
│  └─────────────────┘│
│  選択済: [山田] [×]  │
│                     │
│  共有カレンダー:     │
│  ☑ 会議室A         │
│  ☑ チームカレンダー  │
│                     │
│  テンプレート:       │
│  [保存] [読み込み]   │
└─────────────────────┘
        │
        ▼
┌─────────────────────┐
│   検索条件設定       │
│                     │
│  期間: [今日]〜[1週後]│
│  曜日: ☑月☑火☑水... │
│  時間: [9:00]-[18:00]│
│  最低時間: [30分 ▼]  │
└─────────────────────┘
        │
        ▼
┌─────────────────────┐
│   結果表示           │
│                     │
│  2/24(月)           │
│   10:00-11:00 [作成] │
│   14:00-15:30 [作成] │
│  2/25(火)           │
│   09:00-10:00 [作成] │
│   13:00-17:00 [作成] │
│                     │
│  [カレンダーに表示]   │
│  [結果を共有]        │
└─────────────────────┘
```

## コンポーネント構成

| コンポーネント | 役割 |
|---|---|
| `App` | ルートコンポーネント、画面遷移管理 |
| `PurposeSelector` | 目的選択画面 |
| `MemberPicker` | ユーザー検索＋選択（Autocomplete） |
| `CalendarPicker` | 共有カレンダー選択 |
| `SearchConfig` | 日付・曜日・時間帯の条件設定 |
| `ResultList` | 空き時間の一覧表示 |
| `SlotCard` | 個別の空き時間スロット（予定作成ボタン付き） |
| `EventCreator` | 予定作成モーダル（タイトル・説明・繰り返し設定） |
| `TemplateManager` | テンプレートの保存・読み込み・削除 |
| `ShareDialog` | 結果の共有（コピー、メール、テキスト出力） |
| `RecurrenceSelector` | 繰り返しルール設定UI |

## データフロー

### 認証フロー

```
Chrome Extension
      │
      ├─ chrome.identity.getAuthToken()
      │   └─ Google OAuth 2.0
      │       スコープ:
      │       ・calendar.readonly (予定読取り)
      │       ・calendar.events (予定作成)
      │       ・directory.readonly (ユーザー検索)
      │
      └─ Access Token取得 → API呼び出し
```

### 空き時間検索フロー

```
1. ユーザーがメンバー・条件を入力

2. Service Workerが FreeBusy API を呼び出し
   POST /calendar/v3/freeBusy
   {
     timeMin: "2026-02-23T09:00:00+09:00",
     timeMax: "2026-02-28T18:00:00+09:00",
     items: [
       { id: "yamada@company.com" },
       { id: "sato@company.com" }
     ]
   }

3. レスポンスから各人の「忙しい時間」を取得

4. 全員の「忙しい時間」をマージ

5. 指定条件（曜日・時間帯・最低時間）でフィルタリング

6. 残りの「空き時間スロット」を結果として返却
```

### 予定作成フロー

```
ユーザーが空きスロットを選択
      │
      ▼
EventCreatorモーダル表示
  ・タイトル入力
  ・説明入力
  ・参加者（自動入力）
  ・繰り返し設定（任意）
      │
      ▼
Events API呼び出し
  POST /calendar/v3/calendars/primary/events
  {
    summary: "打ち合わせ",
    start: { dateTime: "..." },
    end: { dateTime: "..." },
    attendees: [...],
    recurrence: ["RRULE:FREQ=WEEKLY;COUNT=10"] // 任意
  }
```

## 追加機能

### テンプレート保存

- メンバー構成＋検索条件をテンプレートとして保存
- `chrome.storage.local` に永続化
- テンプレート名を付けて管理（例：「週次定例メンバー」「プロジェクトA」）
- Popup起動時にテンプレート選択可能

### 結果の共有

- 検索結果をテキスト形式でクリップボードにコピー
- メールリンク生成（mailto: で空き時間リストを本文に入れて送信）
- Slack等への共有用のフォーマット済みテキスト出力

### 繰り返し予定対応

- 予定作成時に繰り返しルール（毎週、隔週、毎月）を指定可能
- Events API の `recurrence` フィールド（RRULE）を使用
- FreeBusy APIは自動的に繰り返し予定を展開済み

## キャッシュ戦略

- FreeBusy結果を5分間キャッシュ（同じ条件での再検索を高速化）
- CalendarList/Directoryは30分間キャッシュ
- `chrome.storage.session` を使用（セッション中のみ保持）

## エラーハンドリング

| シナリオ | 対応 |
|---|---|
| OAuth認証失敗/期限切れ | トークンリフレッシュ → 失敗時は再認証画面表示 |
| 他人のカレンダーへのアクセス権限なし | 「このユーザーの予定を参照する権限がありません」と表示し、スキップ |
| API Rate Limit超過 | 指数バックオフで再試行（最大3回） |
| ネットワークエラー | 「接続できません。再試行してください」と表示 |
| FreeBusy結果が空（予定なし） | 「指定期間はすべて空いています」と表示 |
| 空き時間が見つからない | 「条件に合う空き時間が見つかりません。条件を変更してください」と表示 |
| 予定作成失敗 | エラー詳細を表示し再試行ボタンを提供 |

## デザイン方針

- **UIフレームワーク**: Material UI (MUI)
- **デザインシステム**: Material Design 3 ベース
- **カラー**: Googleブルー (#1a73e8) をプライマリカラー
- **タイポグラフィ**: Google Sans / Roboto
- **コンポーネント**: MUIのChip, Autocomplete, DatePicker等を活用
- **カード**: 角丸、軽いシャドウでフラットなデザイン
- **Content Scriptオーバーレイ**: 空き時間を緑色のハイライトでカレンダー上に表示

## 技術スタック

| 項目 | 技術 |
|---|---|
| 言語 | TypeScript |
| UI | React 19 + Material UI (MUI) |
| ビルド | Vite + CRXJS |
| デザイン | Material Design 3 |
| テスト | Vitest + React Testing Library |
| API通信 | fetch (ネイティブ) |
| 状態管理 | React Context + useReducer |
| ストレージ | chrome.storage.local / chrome.storage.session |

## テスト戦略

- **Vitest** でユニットテスト
  - 空き時間計算ロジック（忙しい時間のマージ、フィルタリング）
  - 日付・時間帯のバリデーション
  - キャッシュのTTL管理
  - テンプレート保存/読み込みロジック
- **コンポーネントテスト**
  - React Testing Libraryで各コンポーネントの表示・操作テスト
- **API層のモック**
  - Google Calendar APIレスポンスをモックしてテスト
